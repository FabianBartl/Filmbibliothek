{% extends 'default.html' %}

{% set asideID = 'search-bar' %}
{% set mainID = 'movie-index' %}

{% block aside %}
	<form id="searchbox" method="GET" action="/">
		<input name="query" type="text" {% if url_params.query %}value="{{ url_params.query }}"{% endif %} placeholder="Filme durchsuchen ..." autofocus>
		<button type="submit">Suchen</button>
		
		<details open>
			<summary>Erweiterte Filter</summary>
			<div class="row">
				<fieldset>
					<label class="title">Suchfilter:</label><br>
					<label>Von </label><input name="year_min" type="number" {% if url_params.year_min %}value="{{ url_params.year_min }}"{% endif %} min="1900" placeholder="untere Jahresgrenze">
					<label>bis </label><input name="year_max" type="number" {% if url_params.year_max %}value="{{ url_params.year_max }}"{% endif %} min="1900" placeholder="obere Jahresgrenze"><br>

					<label>Mit </label><input name="with" type="text" {% if url_params.with %}value="{{ url_params.with }}"{% endif %} placeholder="Name">
					<label>als </label>
					<select name="as">
						<option value="director" {% if url_params.as == 'director' %}selected{% endif %}>Regisseur</option>
						<option value="writer" {% if url_params.as == 'writer' %}selected{% endif %}>Drehbuchautor</option>
						<option value="studio" {% if url_params.as == 'studio' %}selected{% endif %}>Studio</option>
						<option value="genre" {% if url_params.as == 'genre' %}selected{% endif %}>Genre</option>
						<option value="main_cast" {% if url_params.as == 'main_cast' %}selected{% endif %}>Hauptbesetzung</option>
						<option value="camera" {% if url_params.as == 'camera' %}selected{% endif %}>Kamerabesetzung</option>
					</select><br>
				</fieldset>

				<fieldset>
					<label class="title">Filme sortieren nach:</label><br>
					<input name="sort_reversed" type="checkbox" {% if url_params.sort_reversed %}checked{% endif %}><label>Reihenfolge umdrehen</label><br>
					<input name="sort_by" value="title" type="radio" checked><label>Titel</label><br>
					<input name="sort_by" value="year" type="radio" {% if url_params.sort_by == 'year' %}checked{% endif %}><label>Jahr</label><br>
					<input name="sort_by" value="imdb_rating" type="radio" {% if url_params.sort_by == 'imdb_rating' %}checked{% endif %}><label>IMDb Bewertung</label><br>
					<input name="sort_by" value="user_rating" type="radio" {% if url_params.sort_by == 'user_rating' %}checked{% endif %}><label>Eigener Bewertung</label><br>
				</fieldset>

				<fieldset>
					<label class="title">Anzeige Einstellungen:</label><br>
					<input name="hide_age_restricted_movies" type="checkbox" {% if url_params.hide_age_restricted_movies %}checked{% endif %}><label>Filme mit Altersbeschr√§nkung ausblenden</label><br>
					<input name="hide_not_search_results" type="checkbox" {% if url_params.hide_not_search_results %}checked{% endif %}><label>Nur Suchergebnisse anzeigen</label><br>
				</fieldset>
			</div>
		</details>
	</form>
	
	<script>
		$(document).ready(function(){
			// search input field and data source
			var search_input = $("#searchbox > input[name='query']");
			const movies_data = {{ movies_array | safe }};
			
			// call on typing in search field
			search_input.keyup((evt)=>{
				searchResults(
					evt, movies_data, search_input,

					// searchable values
					function(movie) {
						const keys = ["title", "description", "age-rating", "year", "resolution", "director", "writer", "genre", "main-cast", "duration", "camera", "studio", "ratings"];
						var result = [];
						// convert key objects into an array of strings
						keys.forEach((key)=>{
							var object = movie[key];
							if (object !== null && object !== undefined) {
								// handle arrays
								if (typeof(object) === Array) {
									value = object.join("");
								}
								// handle objects
								else if (typeof(object) === Object) {
									var values = [];
									for (let key in object) {
										values.push(object[key]);
									}
									value = values.join("");
								}
								// handle integers, strings, etc.
								else {
									value = object.toString();
								}
								result.push(value);
							}
						});
						return result;
					},

					[
						{% for filter in config.get("not-result-filters", []) %}
							{% if filter in ["unclickable", "hidden", "blurred", "grayed", "darkened", "inverted", "faded", "cleared"] %}
								"{{ filter }}",
							{% else %}
								// filter '{{ filter }}' not allowed
							{% endif %}
						{% endfor %}
						"combine-filters", "not-search-result"
					]
				);
			});
			search_input.keyup();
		});
	</script>
{% endblock %}

{% block main %}
	{% for movie in movies %}
		{% set movieID = movie["movieID"] %}
		{% set age_restricted = false %}
		{% if cookies.get('age_restriction_unlocked') != 'true' %}
			{% if config.get('age-restriction', {}).get('limit') %}
				{% if movie.get('age-rating')|str|first_integer(0) >= config.get('age-restriction', {}).get('limit') %}
					{% set age_restricted = true %}
				{% endif %}
			{% endif %}
		{% endif %}
		
		<div
			id="movie-{{ movieID }}"
			class="movie-overview
				{% if age_restricted %}
					not-allowed age-restricted
					{% if "hidden" in config.get("age-restricted-filters", []) %}hidden{% endif %}
				{% endif %}"
		>
			<a {% if not age_restricted %}href="/movie/{{ movieID }}/"{% endif %}>
				<img
					src="{% if movie.get('poster', '').startswith('http') %}{{ movie.get('poster') }}{% else %}/movie/{{ movieID }}/poster/{% endif %}"
					class="poster
						{% if age_restricted %}combine-filters
							{% for filter in config.get("age-restricted-filters", []) %}
								{% if filter in ["blurred", "grayed", "darkened", "inverted", "faded", "cleared"] %}
									{{ filter }}
								{% endif %}
							{% endfor %}
						{% endif %}"
					alt="movie poster for '{{ movie.get('title') }}'"
				>
			</a>
			<div class="title">
				{% if config.get('title_length', 0) != 0 %}
					{{ movie.title | truncate(config.get('title-length')) }}
				{% else %}
					{{ movie.title }}
				{% endif %}
			</div>
			{% if movie.get('year') %}
				<div class="year">
					{{ movie.get('year') }}
				</div>
			{% endif %}
		</div>
	{% endfor %}

	{% for _ in range(20) %}
		<div class="movie-overview"></div>
	{% endfor %}
{% endblock %}